{% extends 'faithlink/basemenu.html' %}

{% block content %}
<div id="prayer-request-app" class="container py-4">
  <!-- Page Title -->
  <h2 style="font-size: 2.5rem; font-weight: 700; color: #ce7659; margin: 15px 0px;">Prayer Requests</h2>

  <!-- Request Prayer Button -->
  <el-button type="primary" class="mb-3" @click="openAddDialog">+ Request Prayer</el-button>

  <!-- Prayer Request Table -->
  <el-card>
    <v-client-table :columns="columns" :data="prayerRequests" class="mt-3">
      <template slot="action" slot-scope="props">
        <el-button 
          v-if="!props.row.answered" 
          size="small" 
          type="success" 
          @click="markAsAnswered(props.row)">
          Mark as Answered
        </el-button>
        <span v-else class="text-success">Answered</span>
      </template>
    </v-client-table>
  </el-card>

  <!-- Add Prayer Request Modal -->
  <el-dialog :title="editing ? 'Edit Prayer Request' : 'Request Prayer'" :visible.sync="dialogVisible" width="30%">
    <el-form @submit.native.prevent="savePrayerRequest">
      <el-form-item label="Prayer Request" required>
        <el-input
          type="textarea"
          v-model="form.prayer_request"
          placeholder="Enter your prayer request">
        </el-input>
      </el-form-item>
    </el-form>
    <span slot="footer" class="dialog-footer">
      <el-button @click="dialogVisible = false">Cancel</el-button>
      <el-button 
        type="success" 
        @click="savePrayerRequest" 
        v-text="editing ? 'Update' : 'Submit'">
      </el-button>
    </span>
  </el-dialog>
</div>
{% endblock %}

{% block script %}
<script>
  Vue.use(VueTables.ClientTable);

  new Vue({
    el: '#prayer-request-app',
    data() {
      return {
        columns: ['parishioner', 'prayer_request', 'date_requested', 'answered', 'action'],
        prayerRequests: [],
        dialogVisible: false,
        editing: false,
        form: {
          id: null,
          prayer_request: ''
        }
      };
    },
    methods: {
      getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      },
      fetchPrayerRequests() {
        axios.get('/api/prayer-requests/')
          .then(res => {
            this.prayerRequests = res.data;
          })
          .catch(err => {
            console.error('Error fetching prayer requests:', err.response?.data || err.message);
          });
      },
      openAddDialog() {
        this.editing = false;
        this.form = { id: null, prayer_request: '' };
        this.dialogVisible = true;
      },
      savePrayerRequest() {
        const payload = {
          prayer_request: this.form.prayer_request
        };

        const url = this.editing 
          ? `/api/prayer-requests/${this.form.id}/` 
          : '/api/prayer-requests/';
        const method = this.editing ? 'put' : 'post';

        axios({
          method,
          url,
          data: payload,
          headers: {
            'X-CSRFToken': this.getCookie('csrftoken')
          }
        })
        .then(() => {
          this.dialogVisible = false;
          this.fetchPrayerRequests();
        })
        .catch(err => {
          console.error('Error saving prayer request:', err.response?.data || err.message);
        });
      },
      markAsAnswered(prayerRequest) {
        axios.put(`/api/prayer-requests/${prayerRequest.id}/`, {
          answered: true
        }, {
          headers: {
            'X-CSRFToken': this.getCookie('csrftoken')
          }
        })
        .then(() => {
          this.fetchPrayerRequests();
        })
        .catch(err => {
          console.error('Error marking as answered:', err.response?.data || err.message);
        });
      }
    },
    created() {
      this.fetchPrayerRequests();
    }
  });
</script>
{% endblock %}
