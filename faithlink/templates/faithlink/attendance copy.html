{% extends 'faithlink/basemenu.html' %}

{% block content %}
<div id="app" class="container mt-5">
  <h2 style="font-size: 2.5rem; font-weight: 700; color: #ce7659; margin: 15px 0px;">
    Attendance Scanner
  </h2>
  <h3 class="mb-4 text-muted">Attendance / Home</h3>

  <div class="text-center">
    <!-- <label for="event-select" class="form-label fw-bold">Select Event or Mass Type</label> -->
     <div class="d-flex justify-content-center align-items-center gap-2" style="flex-wrap: wrap;">
    <select id="event-select" class="form-select w-auto ">
      <option value="auto_mass">Mass (Auto Detect)</option>
      {% for event in events %}
      <option value="{{ event.id }}">{{ event.name }} - {{ event.date|date:"M d, Y h:i A" }}</option>
      {% endfor %}
    </select>


     <!-- Add Event Modal Button and Dialog -->
    <div id="attendance-app" class="mt-2">
      <el-button type="success" icon="el-icon-plus" class="mb-2" @click="dialogVisible = true" style="font-size: .7rem; padding: 7px;">
        Add New Event
      </el-button>

      <el-dialog title="Create Event" :visible.sync="dialogVisible" width="20%">
        <el-form :model="form" :rules="rules" ref="createForm" label-width="100px" @submit.native.prevent>
          <el-form-item label="Event Name" prop="name">
            <el-input v-model="form.name" placeholder="Enter event name"></el-input>
          </el-form-item>
          <el-form-item label="Date" prop="date">
            <el-date-picker v-model="form.date" type="datetime" placeholder="Select date & time" style="width: 100%;"></el-date-picker>
          </el-form-item>
          <el-form-item label="Location" prop="location">
            <el-input v-model="form.location" placeholder="Enter location"></el-input>
          </el-form-item>
        </el-form>
        <span slot="footer" class="dialog-footer">
          <el-button @click="dialogVisible = false">Cancel</el-button>
          <el-button type="success" @click="createEvent">Create</el-button>
        </span>
      </el-dialog>
    </div>
  </div>  
  </div>
 


  <div id="qr-reader" style="width: 100%; max-width: 500px; margin: 0 auto;"></div>
  <div id="result" class="mt-3 text-center fs-5"></div>

  <div class="text-center mt-4">
    <button id="btn-stop" class="btn btn-warning me-2" disabled>Stop Scanner</button>
    <button id="btn-start" class="btn btn-success">Start Scanner</button>
    <a href="{% url 'attendance-history' %}" class="btn btn-primary ms-2">
      View Attendance Log
    </a>
  </div>
</div>
{% endblock %}

{% block script %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

  <!-- Vue + Element UI -->
<script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://unpkg.com/element-ui/lib/umd/locale/en.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  const csrftoken = getCookie('csrftoken');
  const resultElem = document.getElementById('result');
  const btnStop = document.getElementById('btn-stop');
  const btnStart = document.getElementById('btn-start');
  const html5QrCode = new Html5Qrcode("qr-reader");

  function onScanSuccess(decodedText, decodedResult) {
    const eventSelect = document.getElementById("event-select");
    const selectedValue = eventSelect.value;
    const selectedLabel = eventSelect.options[eventSelect.selectedIndex].text;

    resultElem.innerHTML = `
      <p>Scanned ID: <strong>${decodedText}</strong></p>
      <p>For: <strong>${selectedLabel}</strong></p>
      <p class="text-info">Marking attendance...</p>`;

    html5QrCode.pause();

    fetch('/api/mark-attendance/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken
      },
      body: JSON.stringify({
        parishioner_id: decodedText,
        event_id: selectedValue !== 'auto_mass' ? selectedValue : null,
        auto_mass: selectedValue === 'auto_mass'
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.message) {
        resultElem.innerHTML += `<p class="text-success">${data.message}</p>`;
      } else if (data.error) {
        resultElem.innerHTML += `<p class="text-danger">${data.error}</p>`;
      } else {
        resultElem.innerHTML += `<p class="text-warning">Unexpected response from server.</p>`;
      }
      setTimeout(() => {
        resultElem.innerHTML = '';
        html5QrCode.resume();
      }, 3000);
    })
    .catch(error => {
      resultElem.innerHTML += `<p class="text-danger">Error: ${error.message}</p>`;
      setTimeout(() => {
        resultElem.innerHTML = '';
        html5QrCode.resume();
      }, 3000);
    });
  }

  function onScanFailure(error) {}

  function startScanner() {
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      onScanSuccess,
      onScanFailure
    ).then(() => {
      btnStart.disabled = true;
      btnStop.disabled = false;
      resultElem.innerHTML = '';
    }).catch(err => {
      resultElem.innerHTML = `<p class="text-danger">Failed to start scanner: ${err}</p>`;
    });
  }

  function stopScanner() {
    html5QrCode.stop().then(() => {
      btnStart.disabled = false;
      btnStop.disabled = true;
      resultElem.innerHTML = '<p class="text-muted">Scanner stopped.</p>';
    }).catch(err => {
      resultElem.innerHTML = `<p class="text-danger">Failed to stop scanner: ${err}</p>`;
    });
  }

  btnStart.addEventListener('click', startScanner);
  btnStop.addEventListener('click', stopScanner);

  startScanner(); // Auto-start




  ELEMENT.locale(ELEMENT.lang.en);

  new Vue({
    el: '#attendance-app',
    data() {
      return {
        dialogVisible: false,
        form: {
          name: '',
          date: '',
          location: ''
        },
        rules: {
          name: [{ required: true, message: 'Event name is required', trigger: 'blur' }],
          date: [{ type: 'date', required: true, message: 'Date is required', trigger: 'change' }],
          location: [{ required: true, message: 'Location is required', trigger: 'blur' }]
        }
      };
    },
    methods: {
      getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
              cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
              break;
            }
          }
        }
        return cookieValue;
      },
      createEvent() {
        this.$refs.createForm.validate(valid => {
          if (!valid) return;
          axios.post('/api/events/', this.form, {
            headers: { 'X-CSRFToken': this.getCookie('csrftoken') }
          }).then(() => {
            this.$notify({ title: 'Success', message: 'Event created successfully!', type: 'success' });
            this.dialogVisible = false;
            this.form = { name: '', date: '', location: '' };
            this.refreshEventDropdown();
          }).catch(() => {
            this.$notify({ title: 'Error', message: 'Failed to create event.', type: 'error' });
          });
        });
      },
      refreshEventDropdown() {
        axios.get('/api/events/').then(res => {
          const eventSelect = document.getElementById("event-select");
          const now = new Date();
          const filtered = res.data.filter(event => new Date(event.date) > now);
          eventSelect.innerHTML = `<option value="auto_mass">Mass (Auto Detect)</option>`;
          filtered.forEach(event => {
            const opt = document.createElement('option');
            opt.value = event.id;
            opt.textContent = `${event.name} - ${new Date(event.date).toLocaleString()}`;
            eventSelect.appendChild(opt);
          });
        });
      }
    }
  });

</script>
{% endblock %}
